# Data Fetching Guidelines

**CRITICAL**: This document defines the ONLY acceptable patterns for data fetching in this application. Deviations from these patterns are NOT permitted.

## Core Principles

### 1. Server Components ONLY

**ALL data fetching MUST be done in Server Components.**

- ✅ **CORRECT**: Fetch data in Server Components using async/await
- ❌ **FORBIDDEN**: Route handlers (API routes)
- ❌ **FORBIDDEN**: Client Components with useEffect
- ❌ **FORBIDDEN**: Client-side data fetching libraries
- ❌ **FORBIDDEN**: Any other data fetching pattern

### 2. Data Layer Functions ONLY

**ALL database queries MUST go through helper functions in the `/data` directory.**

- ✅ **CORRECT**: Import and call functions from `/data` directory
- ❌ **FORBIDDEN**: Direct database queries in components
- ❌ **FORBIDDEN**: Raw SQL queries anywhere
- ❌ **FORBIDDEN**: Database access outside the `/data` directory

### 3. Drizzle ORM ONLY

**ALL database queries MUST use Drizzle ORM.**

- ✅ **CORRECT**: Use Drizzle ORM query builder
- ❌ **FORBIDDEN**: Raw SQL strings
- ❌ **FORBIDDEN**: String-based queries
- ❌ **FORBIDDEN**: Any SQL not generated by Drizzle

### 4. User Data Isolation (CRITICAL SECURITY)

**Users MUST ONLY access their own data. This is a security requirement.**

- ✅ **CORRECT**: Filter ALL queries by authenticated user ID
- ❌ **FORBIDDEN**: Queries without user ID filtering
- ❌ **FORBIDDEN**: Cross-user data access
- ❌ **FORBIDDEN**: Admin-style queries that return all users' data

## Required Architecture

### Data Layer Structure

All data access functions MUST be organized in `/data` directory:

```
/data
├── user.ts           # User-related queries
├── workouts.ts       # Workout-related queries
├── exercises.ts      # Exercise-related queries
└── ...
```

### Data Layer Function Pattern

Every data function MUST:
1. Accept `userId` as the first parameter (unless fetching public data)
2. Use Drizzle ORM for all queries
3. Filter by `userId` to enforce data isolation
4. Handle errors appropriately
5. Return type-safe data

**Example data layer function:**

```typescript
// /data/workouts.ts
import { db } from "@/db/drizzle"
import { workouts } from "@/db/schema"
import { eq, and } from "drizzle-orm"

export async function getWorkoutsByUserId(userId: string) {
  // CRITICAL: Always filter by userId
  return await db
    .select()
    .from(workouts)
    .where(eq(workouts.userId, userId))
}

export async function getWorkoutById(userId: string, workoutId: string) {
  // CRITICAL: Filter by BOTH userId AND workoutId
  const result = await db
    .select()
    .from(workouts)
    .where(
      and(
        eq(workouts.userId, userId),
        eq(workouts.id, workoutId)
      )
    )

  return result[0] ?? null
}

// ❌ FORBIDDEN: No userId filtering
export async function getAllWorkouts() {
  return await db.select().from(workouts) // SECURITY VIOLATION!
}
```

### Server Component Pattern

**Example Server Component using data layer:**

```typescript
// app/dashboard/page.tsx
import { auth } from "@clerk/nextjs/server"
import { getWorkoutsByUserId } from "@/data/workouts"
import { redirect } from "next/navigation"

export default async function DashboardPage() {
  // 1. Get authenticated user
  const { userId } = await auth()

  // 2. Redirect if not authenticated
  if (!userId) {
    redirect("/sign-in")
  }

  // 3. Fetch data using data layer function
  const workouts = await getWorkoutsByUserId(userId)

  // 4. Render with data
  return (
    <div>
      <h1>My Workouts</h1>
      {workouts.map(workout => (
        <div key={workout.id}>{workout.name}</div>
      ))}
    </div>
  )
}
```

## Security Checklist

Before deploying ANY data-fetching code, verify:

- [ ] Is data fetched in a Server Component? (not Client Component)
- [ ] Does the query use a `/data` helper function? (not inline query)
- [ ] Does the helper function use Drizzle ORM? (not raw SQL)
- [ ] Is the query filtered by `userId`? (critical security check)
- [ ] Does the user authentication happen before data fetching?
- [ ] Is there a redirect for unauthenticated users?

## Common Mistakes to Avoid

### ❌ MISTAKE 1: Client-Side Fetching

```typescript
"use client"

export default function DashboardPage() {
  const [data, setData] = useState([])

  useEffect(() => {
    fetch("/api/workouts").then(/* ... */)  // ❌ WRONG!
  }, [])
}
```

**Why wrong**: Data should be fetched in Server Components, not client-side.

### ❌ MISTAKE 2: Route Handlers

```typescript
// app/api/workouts/route.ts
export async function GET() {
  const workouts = await db.select().from(workouts)  // ❌ WRONG!
  return Response.json(workouts)
}
```

**Why wrong**: We don't use route handlers for data fetching. Use Server Components.

### ❌ MISTAKE 3: Raw SQL

```typescript
export async function getWorkouts(userId: string) {
  return await db.execute(
    `SELECT * FROM workouts WHERE user_id = '${userId}'`  // ❌ WRONG!
  )
}
```

**Why wrong**: Must use Drizzle ORM, not raw SQL (also SQL injection risk).

### ❌ MISTAKE 4: Missing User Filtering

```typescript
export async function getWorkoutById(workoutId: string) {
  return await db
    .select()
    .from(workouts)
    .where(eq(workouts.id, workoutId))  // ❌ SECURITY VIOLATION!
}
```

**Why wrong**: Missing `userId` filter allows users to access other users' data.

### ❌ MISTAKE 5: Inline Database Queries

```typescript
// app/dashboard/page.tsx
export default async function DashboardPage() {
  // ❌ WRONG: Direct database query in component
  const workouts = await db.select().from(workouts)

  return <div>{/* ... */}</div>
}
```

**Why wrong**: All queries must go through `/data` helper functions.

## Benefits of This Architecture

1. **Security**: Centralized user data isolation enforcement
2. **Type Safety**: Drizzle ORM provides full TypeScript support
3. **Performance**: Server Components fetch data efficiently
4. **Maintainability**: Single source of truth for data access logic
5. **Testing**: Data layer functions are easy to test in isolation
6. **DRY**: Reusable data functions across multiple pages

## Summary

**The Rule**: Server Components → `/data` functions → Drizzle ORM → User-filtered queries

Follow this pattern for EVERY piece of data in the application. No exceptions.
